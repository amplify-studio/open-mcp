# MCP Services + Firecrawl 集成配置
# 包含: Firecrawl API + Playwright + PostgreSQL + Redis + Reader Adapter + SearXNG + Nginx

# 日志配置
x-logging-standard: &logging-standard
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    compress: "true"

x-logging-small: &logging-small
  driver: "json-file"
  options:
    max-size: "5m"
    max-file: "2"
    compress: "true"

x-firecrawl-common: &firecrawl-common
  image: ghcr.io/firecrawl/firecrawl:latest
  ulimits:
    nofile:
      soft: 65535
      hard: 65535
  networks:
    - mcp-network
  extra_hosts:
    - "host.docker.internal:host-gateway"
  logging: *logging-standard

x-firecrawl-env: &firecrawl-env
  # Redis 配置
  REDIS_URL: ${REDIS_URL:-redis://redis:6379}
  REDIS_RATE_LIMIT_URL: ${REDIS_URL:-redis://redis:6379}

  # Playwright 配置
  PLAYWRIGHT_MICROSERVICE_URL: ${PLAYWRIGHT_MICROSERVICE_URL:-http://playwright-service:3000/scrape}

  # PostgreSQL 配置
  POSTGRES_USER: ${POSTGRES_USER:-postgres}
  POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
  POSTGRES_DB: ${POSTGRES_DB:-postgres}
  POSTGRES_HOST: ${POSTGRES_HOST:-nuq-postgres}
  POSTGRES_PORT: ${POSTGRES_PORT:-5432}

  # 认证配置
  USE_DB_AUTHENTICATION: ${USE_DB_AUTHENTICATION:-false}

  # Worker 配置
  NUM_WORKERS_PER_QUEUE: ${NUM_WORKERS_PER_QUEUE:-2}
  CRAWL_CONCURRENT_REQUESTS: ${CRAWL_CONCURRENT_REQUESTS:-5}
  MAX_CONCURRENT_JOBS: ${MAX_CONCURRENT_JOBS:-2}
  BROWSER_POOL_SIZE: ${BROWSER_POOL_SIZE:-2}

  # 可选功能
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}
  MODEL_NAME: ${MODEL_NAME:-}
  MODEL_EMBEDDING_NAME: ${MODEL_EMBEDDING_NAME:-}
  OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-}

  # Webhook 配置
  SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
  SELF_HOSTED_WEBHOOK_URL: ${SELF_HOSTED_WEBHOOK_URL:-}

  # 日志配置
  LOGGING_LEVEL: ${LOGGING_LEVEL:-INFO}

  # 代理配置
  PROXY_SERVER: ${PROXY_SERVER:-}
  PROXY_USERNAME: ${PROXY_USERNAME:-}
  PROXY_PASSWORD: ${PROXY_PASSWORD:-}
  BLOCK_MEDIA: ${BLOCK_MEDIA:-}

  # 不使用 RabbitMQ
  NUQ_RABBITMQ_URL: ""

  # SearXNG 搜索引擎配置
  SEARXNG_ENDPOINT: ${SEARXNG_ENDPOINT:-http://mcp-searxng:8888}
  SEARXNG_ENGINES: ${SEARXNG_ENGINES:-}
  SEARXNG_CATEGORIES: ${SEARXNG_CATEGORIES:-}

services:
  # ==================== Playwright 浏览器服务 ====================
  playwright-service:
    image: ghcr.io/firecrawl/playwright-service:latest
    restart: unless-stopped
    environment:
      PORT: 3000
      PROXY_SERVER: ${PROXY_SERVER:-}
      PROXY_USERNAME: ${PROXY_USERNAME:-}
      PROXY_PASSWORD: ${PROXY_PASSWORD:-}
      BLOCK_MEDIA: ${BLOCK_MEDIA:-}
      MAX_CONCURRENT_PAGES: ${CRAWL_CONCURRENT_REQUESTS:-5}
    networks:
      - mcp-network
    cpus: 1.0
    mem_limit: 2G
    memswap_limit: 2G
    logging: *logging-standard
    tmpfs:
      - /tmp/.cache:noexec,nosuid,size=512m

  # ==================== Firecrawl API 服务 ====================
  firecrawl-api:
    <<: *firecrawl-common
    restart: unless-stopped
    environment:
      <<: *firecrawl-env
      HOST: "0.0.0.0"
      PORT: ${INTERNAL_PORT:-3002}
      EXTRACT_WORKER_PORT: ${EXTRACT_WORKER_PORT:-3004}
      WORKER_PORT: ${WORKER_PORT:-3005}
      ENV: local
    depends_on:
      redis:
        condition: service_started
      playwright-service:
        condition: service_started
      nuq-postgres:
        condition: service_started
    ports:
      - "${PORT:-3002}:${INTERNAL_PORT:-3002}"
    command: ["node", "dist/src/index.js"]
    cpus: 1.0
    mem_limit: 3G
    memswap_limit: 3G

  # ==================== Redis (Rate Limiting) ====================
  redis:
    image: redis:alpine
    restart: unless-stopped
    networks:
      - mcp-network
    command: redis-server --bind 0.0.0.0
    logging: *logging-small

  # ==================== PostgreSQL 数据库 ====================
  nuq-postgres:
    build:
      context: ./services/nuq-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    networks:
      - mcp-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
    logging: *logging-standard

  # ==================== Firecrawl Reader Adapter (Jina 兼容) ====================
  firecrawl-reader-adapter:
    build:
      context: ./services/firecrawl-reader-adapter
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      FIRECRAWL_API_URL: ${FIRECRAWL_API_URL:-http://firecrawl-api:3002}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-}
      PORT: 8082
    networks:
      - mcp-network
    depends_on:
      firecrawl-api:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8082/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    logging: *logging-small

  # ==================== SearXNG 搜索引擎服务 ====================
  mcp-searxng:
    build:
      context: ./docker/searxng
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8888:8888"
    volumes:
      - ./config/nginx/searxng-settings.yml:/etc/searxng/settings.yml:ro
      - searxng-cache:/var/cache/searxng
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8888/search?q=test')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    cpus: 0.5
    mem_limit: 512M
    logging: *logging-small

  # ==================== Nginx API 网关 ====================
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "3333:3333"
    depends_on:
      mcp-searxng:
        condition: service_healthy
      firecrawl-reader-adapter:
        condition: service_healthy
      firecrawl-api:
        condition: service_started
    volumes:
      # 挂载配置文件
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      # 可选：日志持久化
      # - ./logs/nginx:/var/log/nginx
    command:
      - /bin/sh
      - -c
      - |
        rm -f /etc/nginx/conf.d/default.conf
        exec nginx -g 'daemon off;'
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  mcp-network:
    driver: bridge

volumes:
  searxng-cache:
  postgres-data:

# ==================== 说明 ====================
#
# 本配置包含 7 个服务：
# 1. playwright-service - 浏览器自动化 (支持动态内容)
# 2. firecrawl-api - Firecrawl API 服务器 (3002)
# 3. redis - Rate Limiting 和缓存
# 4. nuq-postgres - 数据库
# 5. firecrawl-reader-adapter - Jina Reader 兼容接口 (8082)
# 6. mcp-searxng - 搜索引擎服务 (8888)
# 7. nginx - API 网关 (80, 3333)
#
# API 端点（通过 nginx 访问）：
# - 搜索: http://localhost:80/api/search/
# - 抓取: http://localhost:80/api/read/<url>
# - Firecrawl Search: http://localhost:80/api/firecrawl-search
# - 状态: http://localhost:80/api/status
#
# 直接访问：
# - Firecrawl API: http://localhost:3002 (v1/scrape, v1/search)
# - SearXNG: http://localhost:8888
# - Reader Adapter: http://localhost:8082 (仅内部)
#
# 使用方法：
# docker compose --env-file .env up -d
